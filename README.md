# Домашнее задание к занятию «Резервное копирование баз данных» Тимахова Наталья

# Задание 1. Резервное копирование

Для финансовой компании, которая хочет повысить надежность резервного копирования и обеспечить возможность быстрого восстановления данных, стоит рассмотреть несколько подходов. 

---

### 1.1 Полное восстановление данных за предыдущий день

Чтобы обеспечить восстановление данных в полном объёме за предыдущий день, можно использовать полное резервное копирование, которое выполняется ежедневно в определенное время, например, ночью или в период минимальной нагрузки на систему.

Полное резервное копирование включает в себя копирование всех данных и может выполняться по следующему графику:
- Каждый день создаётся полный снимок всей базы данных.
- Такие бэкапы можно хранить на внешних серверах или облачном хранилище для дополнительной безопасности.

Достоинства:
- Все данные легко восстанавливаются из одного резервного копирования.
- Упрощает управление, так как есть одно место для восстановления данных за целый день.

Недостатки:
- Требует значительных ресурсов хранения и времени для завершения полной копии, особенно на больших объёмах данных.

---

### 1.2 Восстановление данных за час до предполагаемой поломки

Для восстановления данных с точностью до часа, важно использовать инкрементное или дифференциальное резервное копирование совместно с регулярными журналами транзакций.

1. Инкрементное резервное копирование:
   - Каждый час после выполнения полного резервного копирования создаются инкрементные копии, в которых фиксируются только изменения с момента последнего бэкапа.
   - При сбое можно восстановить данные до нужного времени, применив последовательность инкрементных бэкапов к последнему полному бэкапу.

2. Журналирование транзакций:
   - Использование журналов транзакций позволяет восстанавливать базу до определенного состояния (point-in-time recovery) с точностью до одной транзакции. Если база поддерживает такую функцию, то можно восстанавливать данные с точностью до определенного времени.
   - Журналы транзакций могут архивироваться и записываться каждый час или чаще, что даст возможность «откатиться» до состояния, зафиксированного часом ранее.

Достоинства:
- Минимальный объём хранения, поскольку копируются только изменения.
- Поддержка точного времени восстановления данных в случае сбоя.

Недостатки:
- Сложность восстановления, поскольку необходимо последовательно накладывать инкрементные бэкапы на полное копирование.
- Более высокий риск ошибки при восстановлении, так как требуется больше этапов.

---

### 1.3 Мгновенное переключение на работающую базу при поломке

Для обеспечения бесперебойной работы базы данных при сбое можно использовать репликацию данных и кластеризацию. Репликация данных создает синхронизированные копии базы, а кластеризация позволяет автоматически переключаться на рабочий экземпляр базы при отказе основного.

1. Репликация:
   - Настраивается основная база данных (Primary) и резервная (Secondary), которая получает все обновления данных в режиме реального времени.
   - В случае сбоя основного сервера резервная база может быть настроена на автоматическое поднятие в роли основной.
  
2. Кластеризация и отказоустойчивость (Failover Clustering):
   - В кластере базы данных (например, с использованием PostgreSQL, MySQL или других систем, поддерживающих такую функцию) можно настроить автоматическое переключение на рабочий экземпляр в случае отказа основной базы.
   - При поломке система автоматически переключается на один из резервных узлов, что обеспечивает непрерывность работы.

3. Географически распределенные репликации:
   - Данные могут реплицироваться на географически удаленные серверы, что позволяет быстро восстановить доступ к базе в случае сбоя в одном из центров обработки данных.

Достоинства:
- Обеспечивает практически моментальное переключение на резервный сервер, минимизируя простой.
- Снижает вероятность потери данных, так как репликация происходит практически в реальном времени.

Недостатки:
- Требует сложной настройки и значительных ресурсов для поддержки реплицированной или кластеризованной инфраструктуры.
- Высокие затраты на оборудование и обслуживание дополнительных серверов.

--- 

Для финансовой компании, где надежность и минимизация простоев особенно важны, комбинированный подход, включающий полное резервное копирование, инкрементные бэкапы и кластеризацию, может быть оптимальным решением для обеспечения гибкости восстановления данных и отказоустойчивости базы.

# Задание 2. PostgreSQL

### 2.1 Резервирование и восстановление данных в PostgreSQL с использованием pg_dump и pg_restore

Команда резервного копирования базы данных с использованием `pg_dump`:

`pg_dump` — это утилита PostgreSQL, которая позволяет создать дамп базы данных в виде SQL-скрипта или архивного файла, пригодного для восстановления.

```
pg_dump -U имя_пользователя -d имя_базы -F c -f путь_к_файлу_дампа
```

- `-U имя_пользователя` — имя пользователя PostgreSQL, от имени которого выполняется команда.
- `-d имя_базы` — имя базы данных для резервирования.
- `-F c` — формат архива (сжатый формат `custom`), который можно использовать с `pg_restore`.
- `-f путь_к_файлу_дампа` — путь, по которому будет сохранён файл резервной копии.

Пример:

```
pg_dump -U postgres -d mydatabase -F c -f /backup/mydatabase_backup.dump
```

Команда восстановления базы данных с использованием `pg_restore`:

Для восстановления базы данных из созданного архива используется `pg_restore`.

```
pg_restore -U имя_пользователя -d имя_базы -c путь_к_файлу_дампа
```

- `-U имя_пользователя` — имя пользователя PostgreSQL.
- `-d имя_базы` — база данных, в которую будет восстановлена резервная копия.
- `-c` — очищает объекты из базы данных перед восстановлением (используется осторожно, так как может удалять существующие данные).
- `путь_к_файлу_дампа` — путь к файлу резервной копии.

Пример:

```
pg_restore -U postgres -d mydatabase -c /backup/mydatabase_backup.dump
```

### 2.1.* Возможность автоматизации процесса резервного копирования и восстановления

1. Скрипты на Bash и планировщик задач (cron):
   - Создаётся скрипт, который выполняет команды `pg_dump` для регулярного резервного копирования.
   - Этот скрипт можно настроить в `cron` для регулярного запуска, например, каждый день или каждый час.

Пример скрипта для автоматического резервного копирования:

```
#!/bin/bash

# Параметры для PostgreSQL
USER="postgres"
DB_NAME="mydatabase"
BACKUP_DIR="/backup"
DATE=$(date +\%Y-\%m-\%d)

# Выполнение резервного копирования
pg_dump -U $USER -d $DB_NAME -F c -f "$BACKUP_DIR/${DB_NAME}_$DATE.dump"

# Удаление старых резервных копий (старше 7 дней)
find $BACKUP_DIR -type f -name "*.dump" -mtime +7 -exec rm {} \;
```

Добавление задания в `cron` для ежедневного запуска в 2:00 утра:

```
0 2 * * * /path/to/backup_script.sh
```

2. Использование систем управления резервным копированием (например, Bacula, pgBackRest):
   - `pgBackRest` — это инструмент для резервного копирования PostgreSQL, который поддерживает инкрементное копирование и репликацию.
   - Такие системы позволяют создать продвинутые правила, включая шифрование, сжатие, проверку целостности резервных копий и уведомления.

3. Автоматизация с помощью Ansible или других инструментов управления конфигурацией:
   - Ansible может выполнять резервное копирование, настройку расписания и проверки состояния PostgreSQL на удалённых серверах, что особенно полезно в распределённых системах.

4. Облачные службы:
   - Если база данных развернута в облаке, некоторые провайдеры предлагают встроенные инструменты резервного копирования и восстановления с поддержкой расписания (например, Amazon RDS, Google Cloud SQL).

# Задание 3. MySQL

### 3.1 Инкрементное резервное копирование базы данных MySQL

В MySQL инкрементное резервное копирование можно выполнить с помощью утилиты `mysqlbackup`, входящей в состав MySQL Enterprise Backup. Она позволяет выполнять копии, включающие только изменения данных с последнего полного или инкрементного бэкапа, что экономит место и время на выполнение резервных копий.

Пример:

```
mysqlbackup --user=имя_пользователя --password=пароль \
  --incremental --incremental-base=dir:/путь_к_последнему_полному_бэкапу \
  --backup-dir=/путь_для_сохранения_инкрементного_бэкапа backup
```

- `--incremental` — указывает, что создаётся инкрементная копия.
- `--incremental-base=dir:/путь_к_последнему_полному_бэкапу` — путь к последней полной резервной копии, относительно которой создаётся инкрементный бэкап.
- `--backup-dir=/путь_для_сохранения_инкрементного_бэкапа` — директория, куда будет сохранена инкрементная копия.

Примечание: Если доступна только версия MySQL Community, а не MySQL Enterprise, аналогичное инкрементное копирование можно выполнять с помощью бинарных журналов (binary logs), но этот процесс сложнее и менее автоматизирован.

### 3.1.* Преимущества использования реплики по сравнению с обычным резервным копированием

Использование реплики базы данных в некоторых случаях может дать значительные преимущества по сравнению с обычным резервным копированием. Вот несколько сценариев, когда репликация будет более выгодной:

1. Минимизация времени простоя:
   - Репликация позволяет практически моментально переключиться на копию базы данных в случае сбоя основного сервера, тогда как восстановление из резервной копии требует времени, особенно для больших объёмов данных.

2. Снижение нагрузки на основную базу данных:
   - Реплика может быть использована для обработки запросов на чтение (например, для отчетности), что снижает нагрузку на основной сервер и улучшает производительность при большом количестве операций чтения.

3. Повышение отказоустойчивости и доступности:
   - Репликация помогает создавать резервные копии в реальном времени, так что в случае сбоя данные теряются минимально, в отличие от традиционного резервного копирования, при котором данные могут быть утеряны до последнего выполнения бэкапа.

4. Поддержка географически распределённых пользователей:
   - Репликация позволяет разместить копии базы данных ближе к пользователям в разных регионах, что ускоряет доступ к данным и снижает задержки.

5. Тестирование и обновления:
   - Реплика может использоваться для тестирования обновлений и изменений перед их применением к основной базе, что снижает риск ошибок и потерь данных в боевой системе.

Таким образом, репликация выгодна при высоких требованиях к отказоустойчивости, доступности, производительности и минимизации времени простоя. В то время как обычное резервное копирование подходит для долгосрочного хранения данных и для катастрофического восстановления, репликация позволяет обеспечить непрерывность бизнеса и более оперативное восстановление при сбоях.
